<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd"
	objectQuotingStrategy="QUOTE_ALL_OBJECTS">

	<property name="type.binary" value="binary(255)" dbms="hsqldb" />
	<property name="type.binary" value="bytea" dbms="postgresql" />
	<property name="type.gameSessionId" value="varchar(10)" />

	<!-- This is required to work around https://hibernate.atlassian.net/browse/HHH-9427. -->
	<property name="name.GameRound.gameSessionId" value="GAMESESSIONID"
		dbms="hsqldb" />
	<property name="name.GameRound.gameSessionId" value="gamesessionid"
		dbms="postgresql" />

	<!-- This is required to work around https://hibernate.atlassian.net/browse/HHH-9430 
		and https://hibernate.atlassian.net/browse/HHH-9431. -->
	<property name="option.autoIncrement" value="true" dbms="hsqldb" />
	<property name="option.autoIncrement" value="false" dbms="postgresql" />

	<changeSet id="1" author="karlmdavis">
	
		<createTable tableName="Accounts">
			<column name="id" type="bigint" autoIncrement="${option.autoIncrement}"
				startWith="1">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="varchar(40)" />
		</createTable>
		
		<createTable tableName="AccountRoles">
			<column name="accountId" type="bigint">
				<constraints primaryKey="true" nullable="false"
					foreignKeyName="AccountRolesToAccounts" referencedTableName="Accounts" />
			</column>
			<column name="role" type="varchar(50)">
				<constraints primaryKey="true" nullable="false" />
			</column>
		</createTable>
		
		<createTable tableName="AuthTokens">
			<column name="token" type="${type.binary}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="accountId" type="bigint">
				<constraints nullable="false" foreignKeyName="AuthTokensToAccounts"
					referencedTableName="Accounts" />
			</column>
			<column name="creationTimestamp" type="timestamp">
				<constraints nullable="false" />
			</column>
		</createTable>
		
		<createTable tableName="GameLoginIdentities">
			<column name="id" type="bigint" autoIncrement="${option.autoIncrement}"
				startWith="1">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="accountId" type="bigint">
				<constraints nullable="false" foreignKeyName="GameLoginIdentitiesToAccounts"
					referencedTableName="Accounts" />
			</column>
			<column name="emailAddress" type="varchar(255)">
				<constraints nullable="false" unique="true" />
			</column>
			<column name="passwordHash" type="varchar(255)">
				<constraints nullable="false" />
			</column>
		</createTable>
		
		<createTable tableName="GuestLoginIdentities">
			<column name="id" type="bigint" autoIncrement="${option.autoIncrement}"
				startWith="1">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="accountId" type="bigint">
				<constraints nullable="false" foreignKeyName="GuestLoginIdentitiesToAccounts"
					referencedTableName="Accounts" />
			</column>
		</createTable>

		<createTable tableName="GameSessions">
			<column name="id" type="${type.gameSessionId}">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="createdTimestamp" type="timestamp">
				<constraints nullable="false" />
			</column>
			<column name="state" type="varchar(50)">
				<constraints nullable="false" />
			</column>
			<column name="maxRounds" type="int">
				<constraints nullable="false" />
			</column>
			<column name="player1Id" type="bigint">
				<constraints foreignKeyName="GameSessionsToPlayers1"
					referencedTableName="Players" />
			</column>
			<column name="player2Id" type="bigint">
				<constraints foreignKeyName="GameSessionsToPlayers2"
					referencedTableName="Players" />
			</column>
		</createTable>
		
		<createTable tableName="Players">
			<column name="id" type="bigint" autoIncrement="${option.autoIncrement}"
				startWith="1">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="humanAccountId" type="bigint">
				<constraints nullable="false" unique="true"
					foreignKeyName="PlayersToAccounts" referencedTableName="Accounts" />
			</column>
		</createTable>
		
		<createTable tableName="GameRounds">
			<column name="${name.GameRound.gameSessionId}" type="${type.gameSessionId}">
				<constraints primaryKey="true" nullable="false"
					foreignKeyName="AccountRolesToAccounts" referencedTableName="Accounts" />
			</column>
			<column name="roundIndex" type="int">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="throwForPlayer1" type="varchar(50)">
				<constraints nullable="true" />
			</column>
			<column name="throwForPlayer1Timestamp" type="timestamp" />
			<column name="throwForPlayer2" type="varchar(50)">
				<constraints nullable="true" />
			</column>
			<column name="throwForPlayer2Timestamp" type="timestamp" />
		</createTable>

		<!-- Create a TRIGGER-based constraint that ensures that GameRounds.throwForPlayerN 
			can only ever be set once. This is required in the face of multiple conflicting 
			concurrent requests, so that only one such request ever succeeds. -->
		<sqlFile path="trigger-GameRounds_throwProtect-hsqldb.sql"
			relativeToChangelogFile="true" splitStatements="false" dbms="hsqldb" />
		<sqlFile path="trigger-GameRounds_throwProtect-postgresql.sql"
			relativeToChangelogFile="true" splitStatements="false" dbms="postgresql" />
		
	</changeSet>

	<changeSet id="2" author="karlmdavis" dbms="postgresql">

		<!-- These are required to work around https://hibernate.atlassian.net/browse/HHH-9430 
			and https://hibernate.atlassian.net/browse/HHH-9431. -->
		<createSequence sequenceName="accounts_id_seq" />
		<createSequence sequenceName="gameloginidentities_id_seq" />
		<createSequence sequenceName="guestloginidentities_id_seq" />
		<createSequence sequenceName="players_id_seq" />

	</changeSet>

</databaseChangeLog>
